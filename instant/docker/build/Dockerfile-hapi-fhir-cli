FROM openjdk:8-alpine
ENV APP_VERSION=5.5.2
ENV DOCKERIZE_VERSION v0.6.1

RUN apk add --no-cache curl

RUN apk add --no-cache openssl

RUN wget https://github.com/jwilder/dockerize/releases/download/$DOCKERIZE_VERSION/dockerize-alpine-linux-amd64-$DOCKERIZE_VERSION.tar.gz \
    && tar -C /usr/local/bin -xzvf dockerize-alpine-linux-amd64-$DOCKERIZE_VERSION.tar.gz \
    && rm dockerize-alpine-linux-amd64-$DOCKERIZE_VERSION.tar.gz

RUN set -eux; \
    apk add --progress \
    tini \
    unzip \
    bash; \
    rm -vrf /var/cache/apk/*

RUN wget -q -O /tmp/hapicli.zip https://github.com/hapifhir/hapi-fhir/releases/download/v${APP_VERSION}/hapi-fhir-${APP_VERSION}-cli.zip

RUN unzip /tmp/hapicli.zip -d /; \
    rm /tmp/hapicli.zip

COPY hapi-cli-entrypoint.sh /hapi-cli-entrypoint.sh

COPY upload-definitions.sh /upload-definitions.sh

RUN chmod +x /hapi-cli-entrypoint.sh

RUN chmod +x /upload-definitions.sh

ENTRYPOINT ["/hapi-cli-entrypoint.sh"]

CMD ["/hapi-fhir-cli", "help"]